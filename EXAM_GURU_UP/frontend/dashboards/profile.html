<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile - Exam Guru UP</title>

<style>
body{
    font-family: Arial, sans-serif;
    background: #3a71bd;
    margin:0;
    padding:20px;
}

.container{
    max-width:700px;
    margin:auto;
}

.card{
    background:rgb(233, 179, 179);
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    margin-bottom:20px;
}

h2{
    text-align:center;
    margin-bottom:15px;
}

.info-box{
    background:#98eb9a;
    padding:12px;
    border-radius:8px;
    margin-bottom:10px;
}

label{
    font-weight:bold;
}

input, select{
    width:100%;
    padding:10px;
    margin-top:5px;
    margin-bottom:15px;
    border-radius:6px;
    border:1px solid #ccc;
}

button{
    padding:10px 15px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
}

.btn-primary{
    background:#2563eb;
    color:white;
}

.btn-secondary{
    background:#6b7280;
    color:white;
}

.msg{
    font-weight:bold;
    margin-top:10px;
}

.success{ color:green; }
.error{ color:red; }
.loading{ color:blue; }
</style>
</head>
<body>

<div class="container">

<!-- Profile Info -->
<div class="card">
<h2>üë§ User Profile</h2>

<div class="info-box">
<label>Name:</label>
<span id="name"></span>
</div>

<div class="info-box">
<label>Email:</label>
<span id="email"></span>
</div>

<div class="info-box">
<label>Category:</label>
<span id="category"></span>
</div>

<div class="info-box">
<label>Sub Category:</label>
<span id="subCategory"></span>
</div>

</div>

<!-- Edit Profile -->
<div class="card">
<h2>‚úèÔ∏è Edit Profile</h2>

<label>Name</label>
<input type="text" id="editName">

<label>Category</label>
<select id="editCategory"></select>

<label>Sub Category</label>
<select id="editSubCategory"></select>

<button class="btn-primary" onclick="updateProfile()" id="updateBtn">
Update Profile
</button>

<div id="updateMsg" class="msg"></div>
</div>
<!-- ADD THIS BELOW EDIT PROFILE CARD -->

<!-- üîê Change Password -->
<div class="card">
<h2>üîê Change Password</h2>

<label>Old Password</label>
<input type="password" id="oldPassword">

<label>New Password</label>
<input type="password" id="newPassword">

<label>Confirm New Password</label>
<input type="password" id="confirmPassword">

<button class="btn-primary" onclick="changePassword()" id="passBtn">
Change Password
</button>

<div id="passMsg" class="msg"></div>
</div>

<div style="text-align:center">
<button onclick="goToDashboard()" class="btn-secondary">
    ‚Üê Back to Dashboard
</button>
</div>

</div>
<script src="config.js"></script>
<script>
    
function goToDashboard(){

    const user = JSON.parse(localStorage.getItem("user"));

    if(!user){
        window.location.href = "../login.html";
        return;
    }

    if(user.role === "admin"){
        window.location.href = "../admin/admin-dashboard.html";
        return;
    }

    if(user.category && user.category.dashboard){
        window.location.href = user.category.dashboard.route;
    } else {
        alert("Dashboard not assigned.");
    }
}
const token = localStorage.getItem("token");
const CATEGORY_API = `${API_BASE_URL}/api/categories`;
if(!token){
   window.location.href = "../login.html";
}

let allCategories = [];

/* ================= LOAD CATEGORIES ================= */

async function loadCategories(){

    const res = await fetch(CATEGORY_API);
    allCategories = await res.json();

    const catSelect = document.getElementById("editCategory");
    catSelect.innerHTML = '<option value="">Select Category</option>';

    allCategories.forEach(cat=>{
        catSelect.innerHTML += `<option value="${cat._id}">${cat.name}</option>`;
    });
}

/* ================= LOAD SUB CATEGORY ================= */

function loadSubCategories(categoryId){

    const subSelect = document.getElementById("editSubCategory");
    subSelect.innerHTML = '<option value="">Select Sub Category</option>';

    const selected = allCategories.find(c=>c._id === categoryId);

    if(selected){
        selected.subCategories.forEach(sub=>{
   const subName = typeof sub === "object" ? sub.name : sub;

   subSelect.innerHTML += `
      <option value="${subName}">${subName}</option>
   `;
});

    }
}

document.getElementById("editCategory")
.addEventListener("change", function(){
    loadSubCategories(this.value);
});

/* ================= LOAD PROFILE ================= */

async function loadProfile(){

    const res = await fetch(`${API_BASE_URL}/api/user/profile`, {
        headers:{ Authorization: "Bearer " + token }
    });

    const data = await res.json();

    if(data.user){

        document.getElementById("name").innerText = data.user.name;
        document.getElementById("email").innerText = data.user.email;
        document.getElementById("category").innerText =
            data.user.category?.name || "Not Selected";
        document.getElementById("subCategory").innerText =
            data.user.subCategory || "Not Selected";

        document.getElementById("editName").value = data.user.name;

        if(data.user.category){
            document.getElementById("editCategory").value =
                data.user.category._id;
            loadSubCategories(data.user.category._id);
            document.getElementById("editSubCategory").value =
                data.user.subCategory;
        }
    }
}

/* ================= UPDATE PROFILE ================= */

async function updateProfile(){

    const name = editName.value;
    const category = editCategory.value;
    const subCategory = editSubCategory.value;
    const msg = updateMsg;

    if(!name || !category || !subCategory){
        msg.innerText="Please fill all fields";
        msg.className="msg error";
        return;
    }

    msg.innerText="Updating...";
    msg.className="msg loading";

    const res = await fetch(
        `${API_BASE_URL}/api/user/update`,
        {
            method:"PUT",
            headers:{
                "Content-Type":"application/json",
                Authorization: "Bearer " + token

            },
            body: JSON.stringify({
                name,
                category,
                subCategory
            })
        }
    );

    const data = await res.json();

    if(res.ok){
        msg.innerText="Profile updated successfully";
        msg.className="msg success";
        loadProfile();
    }else{
        msg.innerText=data.message;
        msg.className="msg error";
    }
}

/* ================= CHANGE PASSWORD ================= */

async function changePassword(){

    const oldPassword = document.getElementById("oldPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const msg = document.getElementById("passMsg");

    if(!oldPassword || !newPassword || !confirmPassword){
        msg.innerText = "Please fill all fields";
        msg.className = "msg error";
        return;
    }

    if(newPassword !== confirmPassword){
        msg.innerText = "Passwords do not match";
        msg.className = "msg error";
        return;
    }

    msg.innerText = "Updating...";
    msg.className = "msg loading";

    const res = await fetch(
        `${API_BASE_URL}/api/user/change-password`,
        {
            method: "PUT",
            headers:{
                "Content-Type":"application/json",
                Authorization: "Bearer " + token

            },
            body: JSON.stringify({
                oldPassword,
                newPassword
            })
        }
    );

    const data = await res.json();

    if(res.ok){
        msg.innerText = "Password changed successfully";
        msg.className = "msg success";

        oldPassword.value = "";
        newPassword.value = "";
        confirmPassword.value = "";
    }
    else{
        msg.innerText = data.message;
        msg.className = "msg error";
    }
}



/* ================= INIT ================= */

loadCategories().then(loadProfile);

</script>

</body>
</html>
