<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Dashboard - Exam Guru UP</title>

<style>

body{
    margin:0;
    font-family: Arial, Helvetica, sans-serif;
    background:#dbae1b;
}

/* HEADER */
.dash-header{
    background:#1e3a8a;
    color:rgb(234, 220, 220);
    padding:15px 30px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.logo{
    font-size:22px;
    font-weight:bold;
}

.header-right{
    display:flex;
    gap:10px;
    align-items:center;
}

button{
    padding:8px 14px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
}

.logout-btn{
    background:#ef4444;
    color:white;
}

.profile-btn{
    background:#10b981;
    color:white;
}

/* DASHBOARD */
.dashboard{
    padding:30px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
    gap:20px;
}

.dash-card{
    background:rgb(127, 237, 234);
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

.dash-card h3{
    margin-top:0;
}

.dash-card button{
    background:#2563eb;
    color:white;
    margin-top:10px;
    width:100%;
}

select{
    width:100%;
    padding:8px;
    margin-top:5px;
    border-radius:6px;
}

.score{
    font-size:20px;
    font-weight:bold;
    color:#5d1070;
}

</style>

</head>
<body>

<header class="dash-header">

<div class="logo">üìò Exam Guru UP</div>

<div class="header-right">

<span id="username">Welcome, Student</span>

<a href="profile.html">
<button class="profile-btn">üë§ Profile</button>
</a>

<button class="logout-btn" id="logoutBtn">Logout</button>

</div>

</header>

<section class="dashboard">

<!-- START QUIZ -->
<div class="dash-card">

<h3>üß† Daily Quiz</h3>
<p>Mixed subject daily practice quiz</p>

<button id="startQuizBtn">
Start Quiz
</button>

</div>

<!-- SCORE -->
<div class="dash-card">

<h3>üìä Your Latest Score</h3>

<p class="score" id="latestScore">
Loading...
</p>

</div>

<!-- LEADERBOARD -->
<div class="dash-card">

<h3>üèÜ Leaderboard</h3>
<p>Top students ranking</p>

<a href="../leaderboard.html">
<button>
View Leaderboard
</button>
</a>

</div>

<!-- SUBJECT QUIZ -->
<div class="dash-card">

<h3>üìò Subject Practice</h3>

<select id="subjectSelect">
<option value="">Select Subject</option>
</select>


<select id="difficultySelect">
<option value="">Select Difficulty</option>
<option value="Easy">Easy</option>
<option value="Medium">Medium</option>
<option value="Hard">Hard</option>
</select>

<button id="startSubjectQuiz">
Start Practice
</button>

</div>

</section>

<script>

/* ================= AUTH CHECK ================= */

const token = localStorage.getItem("token");

if(!token){
    window.location.href = "../login.html";
}

let currentUser = null;

/* ================= LOAD USER FROM DB ================= */

async function loadUser(){

    try{

        const res = await fetch(
            `${API_BASE_URL}/api/user/profile`,
            {
                headers:{ Authorization: "Bearer " + token }
            }
        );

        const data = await res.json();

        if(data.user){

            currentUser = data.user;

            const name = data.user.name;
            const category = data.user.category?.name || "Not Selected";
            const subCategory = data.user.subCategory || "";

            let displayText = category;

            if(subCategory){
                displayText += " - " + subCategory;
            }

            document.getElementById("username").innerText =
            `Welcome, ${name} (${displayText})`;

        }

    } catch(err){

        document.getElementById("username").innerText =
        "Welcome, Student";

    }

}

/* ================= START DAILY QUIZ ================= */

document.getElementById("startQuizBtn")
.addEventListener("click", ()=>{

    if(!currentUser || !currentUser.category){
        alert("Please select your course in profile first");
        return;
    }

    window.location.href =
    `../quiz.html?category=${currentUser.category._id}&subCategory=${currentUser.subCategory}`;

});

/* ================= SUBJECT QUIZ ================= */

document.getElementById("startSubjectQuiz")
.addEventListener("click", ()=>{

    const subject =
    document.getElementById("subjectSelect").value;

    const difficulty =
    document.getElementById("difficultySelect").value;

    if(!subject || !difficulty){
        alert("Please select subject and difficulty");
        return;
    }

    if(!currentUser || !currentUser.category){
        alert("Please select your course in profile first");
        return;
    }

    window.location.href =
    `../quiz.html?category=${currentUser.category._id}&subCategory=${currentUser.subCategory}&subject=${subject}&difficulty=${difficulty}`;

});

/* ================= LOAD LATEST SCORE ================= */

async function loadLatestScore(){

    try{

        const res = await fetch(
        `${API_BASE_URL}/api/score/latest`,
        {
            headers:{ Authorization: "Bearer " + token }
        });

        if(!res.ok){
            throw new Error("Score not found");
        }

        const data = await res.json();

        if(data.total === 0){
            throw new Error("No attempts");
        }

        document.getElementById("latestScore").innerText =
        `Score: ${data.score} | Questions: ${data.total}`;

    }
    catch(err){

        document.getElementById("latestScore").innerText =
        "No attempts yet";

    }
}


/* ================= LOGOUT ================= */

document.getElementById("logoutBtn")
.addEventListener("click", ()=>{

    localStorage.clear();
    window.location.href="../index.html";

});

async function loadSubjects(){
    

    if(!currentUser || !currentUser.category){
        return;
    }

    try{

        const res = await fetch(
            `${API_BASE_URL}/api/quiz/subjects?category=${currentUser.category._id}&subCategory=${currentUser.subCategory}`
        );

        const subjects = await res.json();

        const subjectSelect =
        document.getElementById("subjectSelect");

        subjectSelect.innerHTML =
        `<option value="">Select Subject</option>`;

        subjects.forEach(sub=>{
            subjectSelect.innerHTML +=
            `<option value="${sub}">${sub}</option>`;
        });

    }catch(err){
        console.log("Subject load error");
    }
}


/* ================= INIT ================= */
async function init(){

    await loadUser();      // pehle user load hoga
    await loadSubjects();  // phir subjects load honge
    loadLatestScore();     // score load

}


init();

</script>


</body>
</html>
